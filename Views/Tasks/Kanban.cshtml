@using PMS.Models
@using TaskStatusEnum = PMS.Models.TaskStatus
@model IEnumerable<PMS.Controllers.TasksController.TaskListItemVm>

@{
    ViewData["Title"] = "Task Board";
    // Dynamically set layout based on user role
    Layout = User.IsInRole("Admin") ? "~/Views/Shared/_AdminLayout.cshtml" : "~/Views/Shared/_ProjectManagerLayout.cshtml";
    
    var tasks = Model?.ToList() ?? new List<PMS.Controllers.TasksController.TaskListItemVm>();
    var todoTasks = tasks.Where(t => t.Status == TaskStatusEnum.Todo).ToList();
    var inProgressTasks = tasks.Where(t => t.Status == TaskStatusEnum.InProgress).ToList();
    var blockedTasks = tasks.Where(t => t.Status == TaskStatusEnum.Blocked).ToList();
    var doneTasks = tasks.Where(t => t.Status == TaskStatusEnum.Done).ToList();
}

<style>
    .kanban-board {
        display: flex;
        gap: 1.5rem;
        overflow-x: auto;
        padding: 1rem 0;
        min-height: calc(100vh - 200px);
    }

    .kanban-column {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
    }

    .kanban-column-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .kanban-column-header.todo {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .kanban-column-header.in-progress {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .kanban-column-header.blocked {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .kanban-column-header.done {
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
    }

    .task-count {
        background: rgba(255,255,255,0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
    }

    .kanban-column-body {
        background: #f8f9fa;
        min-height: 500px;
        padding: 1rem;
        border-radius: 0 0 12px 12px;
        border: 2px dashed #dee2e6;
        border-top: none;
        transition: all 0.3s ease;
    }

    .kanban-column-body.drag-over {
        background: #e3f2fd;
        border-color: #2196F3;
    }

    .task-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: move;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

    .task-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }

    .task-card.priority-Urgent {
        border-left-color: #dc3545;
    }

    .task-card.priority-High {
        border-left-color: #ffc107;
    }

    .task-card.priority-Medium {
        border-left-color: #17a2b8;
    }

    .task-card.priority-Low {
        border-left-color: #6c757d;
    }

    .task-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .task-description {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .task-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
        font-size: 0.75rem;
    }

    .task-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
    }

    .task-priority {
        color: white;
    }

    .priority-Urgent { background: #dc3545; }
    .priority-High { background: #ffc107; color: #000; }
    .priority-Medium { background: #17a2b8; }
    .priority-Low { background: #6c757d; }

    .task-project {
        background: #e9ecef;
        color: #495057;
    }

    .task-due {
        color: #6c757d;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .task-due.overdue {
        color: #dc3545;
        font-weight: 600;
    }

    .add-task-btn {
        width: 100%;
        padding: 0.75rem;
        border: 2px dashed #dee2e6;
        background: transparent;
        color: #6c757d;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .add-task-btn:hover {
        border-color: #007bff;
        color: #007bff;
        background: rgba(0,123,255,0.05);
    }

    .board-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .view-toggle {
        display: flex;
        gap: 0.5rem;
    }

    .view-toggle .btn {
        padding: 0.5rem 1rem;
    }

    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

 
</style>

<div class="board-header">
    <div>
        <h3 class="mb-1">Task Board</h3>
        <p class="text-muted mb-0">Drag and drop tasks to update their status</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <!-- View Toggle Buttons -->
        <div class="view-toggle-container">
            <a href="/Tasks" class="btn btn-sm btn-outline-secondary view-toggle-btn">
                <i class="bi bi-table"></i> Table
            </a>
            <a href="/Tasks/Kanban" class="btn btn-sm view-toggle-btn active">
                <i class="bi bi-kanban"></i> Board
            </a>
        </div>
        
        <!-- New Task Button -->
        <a href="/Tasks/Create" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> New Task
        </a>
    </div>
</div>

<div class="kanban-board">
    <!-- TODO Column -->
    <div class="kanban-column">
        <div class="kanban-column-header todo">
            <span><i class="bi bi-circle"></i> To Do</span>
            <span class="task-count">@todoTasks.Count</span>
        </div>
        <div class="kanban-column-body" data-status="@((int)TaskStatusEnum.Todo)">
            @foreach (var task in todoTasks)
            {
                @await Html.PartialAsync("_TaskCard", task)
            }
            <button class="add-task-btn" onclick="quickAddTask(@((int)TaskStatusEnum.Todo))">
                <i class="bi bi-plus"></i> Add Task
            </button>
        </div>
    </div>

    <!-- IN PROGRESS Column -->
    <div class="kanban-column">
        <div class="kanban-column-header in-progress">
            <span><i class="bi bi-arrow-repeat"></i> In Progress</span>
            <span class="task-count">@inProgressTasks.Count</span>
        </div>
        <div class="kanban-column-body" data-status="@((int)TaskStatusEnum.InProgress)">
            @foreach (var task in inProgressTasks)
            {
                @await Html.PartialAsync("_TaskCard", task)
            }
            <button class="add-task-btn" onclick="quickAddTask(@((int)TaskStatusEnum.InProgress))">
                <i class="bi bi-plus"></i> Add Task
            </button>
        </div>
    </div>

    <!-- BLOCKED Column -->
    <div class="kanban-column">
        <div class="kanban-column-header blocked">
            <span><i class="bi bi-exclamation-triangle"></i> Blocked</span>
            <span class="task-count">@blockedTasks.Count</span>
        </div>
        <div class="kanban-column-body" data-status="@((int)TaskStatusEnum.Blocked)">
            @foreach (var task in blockedTasks)
            {
                @await Html.PartialAsync("_TaskCard", task)
            }
            <button class="add-task-btn" onclick="quickAddTask(@((int)TaskStatusEnum.Blocked))">
                <i class="bi bi-plus"></i> Add Task
            </button>
        </div>
    </div>

    <!-- DONE Column -->
    <div class="kanban-column">
        <div class="kanban-column-header done">
            <span><i class="bi bi-check-circle"></i> Done</span>
            <span class="task-count">@doneTasks.Count</span>
        </div>
        <div class="kanban-column-body" data-status="@((int)TaskStatusEnum.Done)">
            @foreach (var task in doneTasks)
            {
                @await Html.PartialAsync("_TaskCard", task)
            }
            <button class="add-task-btn" onclick="quickAddTask(@((int)TaskStatusEnum.Done))">
                <i class="bi bi-plus"></i> Add Task
            </button>
        </div>
    </div>
</div>

<!-- Quick Add Task Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Add Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickAddForm">
                    <input type="hidden" id="quickStatus" name="Status" />
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="Title" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="Description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="Priority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="DueDate" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickTask()">Save Task</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let draggedElement = null;

    // Initialize drag and drop
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
    });

    function initializeDragAndDrop() {
        // Make all task cards draggable
        document.querySelectorAll('.task-card').forEach(card => {
            card.draggable = true;
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });

        // Set up drop zones
        document.querySelectorAll('.kanban-column-body').forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('drop', handleDrop);
            column.addEventListener('dragleave', handleDragLeave);
            column.addEventListener('dragenter', handleDragEnter);
        });
    }

    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        
        document.querySelectorAll('.kanban-column-body').forEach(column => {
            column.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        if (e.target === this) {
            this.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        const dropZone = this;
        const newStatus = dropZone.dataset.status;
        const taskId = draggedElement.dataset.taskId;

        // Move the element visually
        dropZone.insertBefore(draggedElement, dropZone.querySelector('.add-task-btn'));
        dropZone.classList.remove('drag-over');

        // Update task status via AJAX
        updateTaskStatus(taskId, newStatus);

        // Update column counts
        updateColumnCounts();

        return false;
    }

    function updateTaskStatus(taskId, status) {
        fetch('/Tasks/ChangeStatus', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: `id=${taskId}&status=${status}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Task status updated', 'success');
            } else {
                showToast('Failed to update task status', 'error');
                location.reload(); // Reload to restore correct state
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating task status', 'error');
            location.reload();
        });
    }

    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const body = column.querySelector('.kanban-column-body');
            const count = body.querySelectorAll('.task-card').length;
            const countBadge = column.querySelector('.task-count');
            if (countBadge) {
                countBadge.textContent = count;
            }
        });
    }

    function editTask(taskId) {
        window.location.href = `/Tasks/Edit/${taskId}`;
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/Tasks/Delete/${taskId}`;
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                form.appendChild(token.cloneNode());
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    function quickAddTask(status) {
        document.getElementById('quickStatus').value = status;
        new bootstrap.Modal(document.getElementById('quickAddModal')).show();
    }

    function saveQuickTask() {
        const form = document.getElementById('quickAddForm');
        const formData = new FormData(form);
        
        fetch('/Tasks/QuickCreate', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showToast('Failed to create task', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error creating task', 'error');
        });
    }

    function showToast(message, type) {
        // You can implement a toast notification here
        console.log(`${type}: ${message}`);
    }
</script>
}